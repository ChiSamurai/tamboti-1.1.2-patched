<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:bf="http://betterform.sourceforge.net/xforms" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <title>Tamboti Metadata Framework</title>
        <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"/>-->
        <script src="$shared/resources/scripts/jquery/jquery-1.7.1.min.js" type="text/javascript"/>
        <!--<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"/>-->
        <script src="$shared/resources/scripts/jquery/jquery-ui.min.js" type="text/javascript"/>
        <script src="$shared/resources/scripts/jquery/jquery-utils.js" type="text/javascript"/>
        <link href="$shared/resources/scripts/jquery/css/smoothness/jquery.ui.all.css" type="text/css" rel="stylesheet"/>
        <script type="text/javascript" src="$shared/resources/scripts/jquery/jquery.dynatree-1.1.1.min.js"/>
        <script type="text/javascript" src="$shared/resources/scripts/jquery/jquery.dataTables-1.8.1.min.js"/>
        <script type="text/javascript" src="$shared/resources/scripts/jquery/jquery.cookie.js"/>
        <script type="text/javascript" src="resources/scripts/jquery.scrollintoview.min.js"/>
        <script type="text/javascript" src="resources/scripts/jquery-utils.js"/>
        <script type="text/javascript" src="../session.js.xql"/>
        <script type="text/javascript" src="resources/scripts/query.js"/>
        <script type="text/javascript" src="resources/scripts/galleries.js"/>
        <script type="text/javascript" src="resources/scripts/jquery.ieblocker.js"/>
        <link rel="stylesheet" type="text/css" href="$shared/resources/scripts/jquery/skin/ui.dynatree.css"/>
        <link rel="stylesheet" type="text/css" href="theme/css/biblio.css"/>
        <link rel="stylesheet" type="text/css" href="theme/css/theme.css"/>
        <link rel="stylesheet" type="text/css" href="theme/css/upload.css"/>
        <link rel="shortcut icon" href="theme/images/favicon.ico"/>
        <link rel="unapi-server" type="application/xml" title="unAPI" href="unapi.xql"/>
        <script type="text/javascript" src="resources/scripts/angular.min.js"/>
        <link rel="stylesheet" type="text/css" href="../../themes/default/css/upload_angular.css"/>
        <script type="text/javascript" src="../upload/upload.js"/>        
        
        <!--
            <link rel="stylesheet" type="text/css" href="theme/css/upload.css"/>
        -->
    </head>
    <body ng-app="app" ng-controller="FileUploadCtrl">
        <div style="display:none">
            <xf:model id="m-multiple-selection-component">
                <xf:instance xmlns="http://www.lisa.org/tmx14" id="i-ui-text" src="../i18n/tmx.xml"/>
                <xf:instance id="i-configuration">
                    <configuration xmlns="">
                        <languages>
                            <language>en</language>
                            <language>de</language>
                            <language>fr</language>
                        </languages>
                    </configuration>
                </xf:instance>
                <xf:instance id="i-dynamic-values">
                    <selected-values xmlns="">
                        <ui-language>en</ui-language>
                        <number-of-all-options>0</number-of-all-options>
                        <number-of-selected-options>0</number-of-selected-options>
                        <selected-options uuid=""/>
                        <selected-action/>
                    </selected-values>
                </xf:instance>
                <xf:submission id="s-create-uuid-file" resource="{concat('exist:/db/data/temp/', instance('i-dynamic-values')/selected-options/@uuid , '.xml')}" method="put" replace="none" ref="instance('i-dynamic-values')/selected-options" validate="false" serialization="application/xml">
                    <xf:message level="ephemeral" ev:event="xforms-submit-error">put submission failed</xf:message>
                    <xf:action level="ephemeral" ev:event="xforms-submit-done">
                        <script type="text/javascript">
                            Flux.getInstanceDocument('m-multiple-selection-component', 'i-dynamic-values', fluxProcessor.sessionKey, function(data) {
                                var uuid = $(data).find("selected-options").attr("uuid");
                                $.ajax({
                                    type: "GET",
                                    url: '/exist/apps/ziziphus/modules/group/vraGroupEditor.xql?id=' + uuid,
                                    error: function() {
                                        showMessage("Could not send record ids to ziziphus.");
                                    },
                                    success: function(data) {
                                        if (data !== null) {
                                            var win = window.open('about:blank');
                                            with (win.document)
                                            {
                                                open();
                                                write(data);
                                                close();
                                            }
                                        }
                                    }
                                });
                            });
                        </script>
                    </xf:action>
                    <xf:message level="ephemeral" ev:event="xforms-submit">
                        <xf:output value="concat(' exist:/db/temp/', instance('i-dynamic-values')/selected-options/@uuid , '.xml')"/>
                    </xf:message>
                </xf:submission>
                <xf:instance id="i-templates">
                    <templates xmlns="">
                        <option/>
                    </templates>
                </xf:instance>
                <xf:bind ref="instance('i-dynamic-values')">
                    <xf:bind ref="number-of-selected-options" calculate="count(instance('i-dynamic-values')/selected-options/option)"/>
                    <xf:bind ref="selected-action" relevant="count(instance('i-dynamic-values')/selected-options/option) gt 0"/>
                </xf:bind>
                <xf:action ev:event="xforms-ready">
                    <xf:load show="embed" targetid="ddlcb-container">
                        <xf:resource value="'../../components/multiple-selection-component/multiple-selection-component.xml#ddlcb-container'"/>
                        <xf:extension includeCSS="true" includeScript="true"/>
                    </xf:load>
                    <script type="text/javascript">
                        fluxProcessor.dispatchEventType("main-content", "set-number-of-all-options", {
                            "number-of-all-options": $(".hit-count").text()
                        });
                        fluxProcessor.skipshutdown=true;

                        // initialize the check boxes of the search list
                        $("#results").on("click", "tr.pagination-item input.search-list-item-checkbox", function() {
                            //ev.preventDefault();
                            var $this = $(this);
                            var optionId = $this.attr("data-tamboti-record-id");
                            if ($this.is(":checked")) {
                                fluxProcessor.dispatchEventType("main-content", "select-option", {"optionId": optionId});
                            } else {
                                fluxProcessor.dispatchEventType("main-content", "unselect-option", {"optionId": optionId});
                            }
                        });
                		$("#ddlcb-container").on("ddlcb-partial-checked", function() {
                		    var resultsTable = $("#results &gt; table");
                		    
          				    $('input', resultsTable).each(
        				        function(index) {
        				            var $this = $(this);
        				            $this.attr("checked", "checked");
        				            fluxProcessor.dispatchEventType("main-content", "select-option", {"optionId": $this.attr("data-tamboti-record-id")});
        				        }    
        				    );      
                        }); 
                		$("#ddlcb-container").on("ddlcb-partial-unchecked", function() {
                		    var resultsTable = $("#results &gt; table");
                		    
          				    $('input', resultsTable).each(
        				        function(index) {
        				            var $this = $(this);
        				            $this.removeAttr("checked");
        				            fluxProcessor.dispatchEventType("main-content", "unselect-option", {"optionId": $this.attr("data-tamboti-record-id")});
        				        }    
        				    );
                        }); 
                		$("#ddlcb-container").on("ddlcb-page-changed", function() {
                            Flux.getInstanceDocument('m-multiple-selection-component', 'i-dynamic-values', fluxProcessor.sessionKey, function(data) {
                                var dataInstance = $(data).html();
                                var resultsTable = $("#results &gt; table");                                
                                
              				    $("input.search-list-item-checkbox", resultsTable).each(
            				        function(index) {
            				            var recordId = $(this).attr("data-tamboti-record-id");
            				            
            				            if (dataInstance.indexOf(recordId) &gt; -1) {
            				                $("input.search-list-item-checkbox[data-tamboti-record-id = '" + recordId + "']", resultsTable).attr("checked", "checked");
            				            }
            				        }    
            				    );                		                                
                            });
                        });                        
                    </script>
                </xf:action>
                <xf:action ev:event="set-number-of-all-options" ev:observer="main-content">
                    <xf:setvalue ref="instance('i-dynamic-values')/number-of-all-options" value="event('number-of-all-options')"/>
                </xf:action>
                <xf:action ev:event="select-option" ev:observer="main-content" if="not(instance('i-dynamic-values')/selected-options/option[. = event('optionId')])">
                    <xf:setvalue ref="instance('i-templates')/option" value="event('optionId')"/>
                    <xf:insert origin="instance('i-templates')/option" context="instance('i-dynamic-values')/selected-options" at="last()"/>
                    <xf:setvalue ref="instance('i-templates')/option"/>
                    <xf:action if="count(instance('i-dynamic-values')/selected-options/option) lt number(instance('i-dynamic-values')/number-of-all-options)">
                        <script type="text/javascript">
                            $("#ddlcb-container").trigger("flag-ddlcb-partial-checked");
                        </script>
                    </xf:action>
                    <xf:action if="count(instance('i-dynamic-values')/selected-options/option) = instance('i-dynamic-values')/number-of-all-options">
                        <script type="text/javascript">
                            $("#ddlcb-container").trigger("flag-ddlcb-full-checked");
                        </script>
                    </xf:action>
                </xf:action>
                <xf:action ev:event="unselect-option" ev:observer="main-content">
                    <xf:delete ref="instance('i-dynamic-values')/selected-options/option[. = event('optionId')]"/>
                    <xf:action if="count(instance('i-dynamic-values')/selected-options/option) lt number(instance('i-dynamic-values')/number-of-all-options)">
                        <script type="text/javascript">
                            $("#ddlcb-container").trigger("unflag-ddlcb-full-checked");
                            $("#ddlcb-container").trigger("flag-ddlcb-partial-checked");
                        </script>
                    </xf:action>
                    <xf:action if="count(instance('i-dynamic-values')/selected-options/option) = 0">
                        <script type="text/javascript">
                            $("#ddlcb-container").trigger("unflag-ddlcb-partial-checked");
                        </script>
                    </xf:action>
                </xf:action>
                <xf:action ev:event="multiple-editing" ev:observer="main-content">
                    <xf:action if="instance('i-dynamic-values')/selected-action = 'edit'">
                        <xf:setvalue ref="instance('i-dynamic-values')/selected-options/@uuid" value="concat(generate-id(), translate(now(),'T:.Z','---'))"/>
                        <xf:send submission="s-create-uuid-file"/>
                    </xf:action>
                    <xf:action if="instance('i-dynamic-values')/selected-action = ('delete', 'move', 'save', 'export')">
                        <xf:message level="modal">This action is not yet implemented!</xf:message>
                    </xf:action>
                    <xf:setvalue ref="instance('i-dynamic-values')/selected-action"/>
                </xf:action>
            </xf:model>
        </div>
        <div class="templates:include?path=pages/dialogs.html"/>
        <div style="float: right;">
            <xf:group appearance="full" model="m-multiple-selection-component">
                <xf:select1 ref="instance('i-dynamic-values')/ui-language" appearance="minimal" incremental="true">
                    <xf:label>
                        <xf:output value="instance('i-ui-text')//*[@tuid = 'language-selecting-select1']/*[@xml:lang = instance('i-dynamic-values')/ui-language]"/>
                    </xf:label>
                    <xf:itemset ref="instance('i-configuration')/languages/language">
                        <xf:label ref="."/>
                        <xf:value ref="."/>
                    </xf:itemset>
                </xf:select1>
            </xf:group>
        </div>
        <div id="page-head">
            <div id="page-head-left">
                <a href="/exist/apps/tamboti/">
                    <img src="theme/images/tamboti-test.png" title="Tamboti Metadata Framework" alt="Tamboti Metadata Framework"/>
                </a>
            </div>
            <div id="page-head-right">
                <a href="http://www.asia-europe.uni-heidelberg.de/en/home.html" target="_blank">
                    <img src="theme/images/cluster_logo.png" title="The Cluster of Excellence 'Asia and Europe in a Global Context: Shifting Asymmetries in Cultural Flows' at Heidelberg University" alt="The Cluster of Excellence 'Asia and Europe in a Global Context: Shifting Asymmetries in Cultural Flows' at Heidelberg University" width="200"/>
                </a>
            </div>
        </div>
        <div id="content1col">
            <div class="biblio:login"/>
            <div class="biblio:query">
                <div class="templates:include?path=pages/search-form.html"/>
                <div class="templates:include?path=pages/collection-tree.html"/>
                <div id="main-content">
                    <div id="ddlcb-container"/>
                    <div id="results-head">
                        <div class="navbar">
                            <span>
                                <span class="pagination-first">|&lt;</span>
                                <span class="pagination-previous">&lt;</span>
                                <span class="pagination-info"/>
                                <span class="pagination-next">&gt;</span>
                                <span class="pagination-last">&gt;|</span>
                            </span> of 
                            <span class="biblio:result-count result-count"/>
                            <span class="biblio:last-collection-queried last-collection-queried"/>
                            <a class="pagination-toggle" href="#">List view</a>
                            <!--<span class="pagination-mode">
                                View as: 
                                <a href="" class="pagination-mode-list">List</a> |
                                <a href="" class="pagination-mode-gallery">Gallery</a> |
                                <a href="" class="pagination-mode-grid">Grid</a>
                            </span>-->
                        </div>
                        <div id="optimize-trigger"/>
                        <div class="navbar"/>
                    </div>
                    <div id="result-container">
                        <div class="templates:include?path=pages/filters.html"/>
                        <div id="pagination">
                            <div id="results"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--<div id="page-footer">Tamboti Metadata Framework, version 1.0, 2011-09-01. Licence: GNU-LGPL.</div>-->
        <div id="splash"/>
    </body>
</html>
